

首先会被AbstractHmilyTransactionAspect切面里的注解拦截器拦截下来

然后加载了一个LocalParameterLoader拿到context，但context是空的，仔细研究，其实发起者是空的，参与者就是有context的了，

HmilyTransactionAspectInvoker第一次执行![image-20210222234043488](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210222234043488.png)

```
@Override
public Object handler(final ProceedingJoinPoint point, final HmilyTransactionContext context)
        throws Throwable {
    Object returnValue;
    Supplier<Boolean> histogramSupplier = null;
    Optional<MetricsHandlerFacade> handlerFacade = MetricsHandlerFacadeEngine.load();//默认加载了个MetricsTrackerHandlerFacade
    try {
        if (handlerFacade.isPresent()) {
        //但监控没开 所以counterIncrement是跳过的
            handlerFacade.get().counterIncrement(MetricsLabelEnum.TRANSACTION_TOTAL.getName(), TransTypeEnum.TCC.name());
            histogramSupplier = handlerFacade.get().histogramStartTimer(MetricsLabelEnum.TRANSACTION_LATENCY.getName(), TransTypeEnum.TCC.name());//这个没看是不是跳过的 待会看看
        }
        //这个是个关键，preTry就是构建一个Transaction，注册参与者，保存Transaction和TransactionContext的地方
        HmilyTransaction hmilyTransaction = executor.preTry(point);
        try {
            //execute try
            returnValue = point.proceed();
            hmilyTransaction.setStatus(HmilyActionEnum.TRYING.getCode());
            //更新状态没注意看
            executor.updateStartStatus(hmilyTransaction);
        } catch (Throwable throwable) {
            //if exception ,execute cancel
            final HmilyTransaction currentTransaction = HmilyTransactionHolder.getInstance().getCurrentTransaction();
            disruptorProviderManage.getProvider().onData(() -> {
                handlerFacade.ifPresent(metricsHandlerFacade -> metricsHandlerFacade.counterIncrement(MetricsLabelEnum.TRANSACTION_STATUS.getName(),
                        TransTypeEnum.TCC.name(), HmilyRoleEnum.START.name(), HmilyActionEnum.CANCELING.name()));
                executor.globalCancel(currentTransaction);
            });
            throw throwable;
        }
        //execute confirm
        final HmilyTransaction currentTransaction = HmilyTransactionHolder.getInstance().getCurrentTransaction();
        disruptorProviderManage.getProvider().onData(() -> {
            handlerFacade.ifPresent(metricsHandlerFacade -> metricsHandlerFacade.counterIncrement(MetricsLabelEnum.TRANSACTION_STATUS.getName(),
                    TransTypeEnum.TCC.name(), HmilyRoleEnum.START.name(), HmilyActionEnum.CONFIRMING.name()));
            executor.globalConfirm(currentTransaction);
        });
    } finally {
        HmilyContextHolder.remove();
        executor.remove();
        if (null != histogramSupplier) {
            histogramSupplier.get();
        }
    }
    return returnValue;
}
```

![image-20210228202803057](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20210228202803057.png)

这里有两个holder，一个是`hmilyTransaction`的，另外一个是`HmilyTransactionContext`的holder，最后把`hmilyTransaction`返回。

在整个执行过程中，DubboHmilyTransactionFilter是rpc调用的其中一环，每个filter都会被invoke，这个filter主要负责把context传到参与者，来完成跨进程的事务的协调



有个HmilyTransactionSelfRecoveryScheduled.selfTccRecovery负责tcc恢复 具体再研究

onData的顺序，头痛，明天再研究了

```account log
2021-03-02 01:45:20.061  INFO 14740 --- [:20880-thread-6] o.d.h.core.disruptor.DisruptorProvider   : onData: HmilyRepositoryEvent(hmilyTransaction=null, hmilyParticipant=HmilyParticipant(participantId=6832734414966759426, participantRefId=null, transId=6832734414966759424, transType=TCC, status=0, appName=null, role=3, retry=0, targetClass=org.dromara.hmily.demo.dubbo.account.service.AccountServiceImpl, targetMethod=payment, confirmMethod=confirm, cancelMethod=cancel, version=1, createTime=Tue Mar 02 01:45:20 CST 2021, updateTime=Tue Mar 02 01:45:20 CST 2021, confirmHmilyInvocation=HmilyInvocation(targetClass=interface org.dromara.hmily.demo.common.account.api.AccountService, methodName=payment, parameterTypes=[class org.dromara.hmily.demo.common.account.dto.AccountDTO], args=[AccountDTO(userId=10000, amount=1)]), cancelHmilyInvocation=HmilyInvocation(targetClass=interface org.dromara.hmily.demo.common.account.api.AccountService, methodName=payment, parameterTypes=[class org.dromara.hmily.demo.common.account.dto.AccountDTO], args=[AccountDTO(userId=10000, amount=1)])), hmilyParticipantUndo=null, hmilyLocks=null, transId=6832734414966759424, type=20)
2021-03-02 01:45:20.061  INFO 14740 --- [:20880-thread-6] o.d.h.d.d.a.service.AccountServiceImpl   : Account called
2021-03-02 01:45:20.061  INFO 14740 --- [:20880-thread-6] o.d.h.core.disruptor.DisruptorProvider   : onData: HmilyRepositoryEvent(hmilyTransaction=null, hmilyParticipant=HmilyParticipant(participantId=6832734414966759426, participantRefId=null, transId=6832734414966759424, transType=TCC, status=1, appName=null, role=3, retry=0, targetClass=org.dromara.hmily.demo.dubbo.account.service.AccountServiceImpl, targetMethod=payment, confirmMethod=confirm, cancelMethod=cancel, version=1, createTime=Tue Mar 02 01:45:20 CST 2021, updateTime=Tue Mar 02 01:45:20 CST 2021, confirmHmilyInvocation=HmilyInvocation(targetClass=interface org.dromara.hmily.demo.common.account.api.AccountService, methodName=payment, parameterTypes=[class org.dromara.hmily.demo.common.account.dto.AccountDTO], args=[AccountDTO(userId=10000, amount=1)]), cancelHmilyInvocation=HmilyInvocation(targetClass=interface org.dromara.hmily.demo.common.account.api.AccountService, methodName=payment, parameterTypes=[class org.dromara.hmily.demo.common.account.dto.AccountDTO], args=[AccountDTO(userId=10000, amount=1)])), hmilyParticipantUndo=null, hmilyLocks=null, transId=6832734414966759424, type=21)
2021-03-02 01:45:20.062  INFO 14740 --- [g-disruptor1-25] o.d.h.r.d.manager.AbstractHmilyDatabase  : sql is: INSERT INTO hmily_transaction_participant (participant_id, participant_ref_id, trans_id, trans_type, status, app_name,role, retry, target_class, target_method, confirm_method, cancel_method, confirm_invocation, cancel_invocation, version, create_time, update_time) VALUES(?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ? ,? , ? , ?, ?), params is: [6832734414966759426, null, 6832734414966759424, TCC, 1, account-dubbo, 3, 0, org.dromara.hmily.demo.dubbo.account.service.AccountServiceImpl, payment, confirm, cancel, [1, 1, 0, 91, 76, 106, 97, 118, 97, 46, 108, 97, 110, 103, 46, 79, 98, 106, 101, 99, 116, -69, 1, 2, 1, 1, 111, 114, 103, 46, 100, 114, 111, 109, 97, 114, 97, 46, 104, 109, 105, 108, 121, 46, 100, 101, 109, 111, 46, 99, 111, 109, 109, 111, 110, 46, 97, 99, 99, 111, 117, 110, 116, 46, 100, 116, 111, 46, 65, 99, 99, 111, 117, 110, 116, 68, 84, -49, 1, 12, 1, 2, 1, 0, 1, 49, 48, 48, 48, -80, 1, 112, 97, 121, 109, 101, 110, -12, 1, 2, 1, 1, 1, 0, 1, 1, 2, 111, 114, 103, 46, 100, 114, 111, 109, 97, 114, 97, 46, 104, 109, 105, 108, 121, 46, 100, 101, 109, 111, 46, 99, 111, 109, 109, 111, 110, 46, 97, 99, 99, 111, 117, 110, 116, 46, 97, 112, 105, 46, 65, 99, 99, 111, 117, 110, 116, 83, 101, 114, 118, 105, 99, -27, 0], [1, 1, 0, 91, 76, 106, 97, 118, 97, 46, 108, 97, 110, 103, 46, 79, 98, 106, 101, 99, 116, -69, 1, 2, 1, 1, 111, 114, 103, 46, 100, 114, 111, 109, 97, 114, 97, 46, 104, 109, 105, 108, 121, 46, 100, 101, 109, 111, 46, 99, 111, 109, 109, 111, 110, 46, 97, 99, 99, 111, 117, 110, 116, 46, 100, 116, 111, 46, 65, 99, 99, 111, 117, 110, 116, 68, 84, -49, 1, 12, 1, 2, 1, 0, 1, 49, 48, 48, 48, -80, 1, 112, 97, 121, 109, 101, 110, -12, 1, 2, 1, 1, 1, 0, 1, 1, 2, 111, 114, 103, 46, 100, 114, 111, 109, 97, 114, 97, 46, 104, 109, 105, 108, 121, 46, 100, 101, 109, 111, 46, 99, 111, 109, 109, 111, 110, 46, 97, 99, 99, 111, 117, 110, 116, 46, 97, 112, 105, 46, 65, 99, 99, 111, 117, 110, 116, 83, 101, 114, 118, 105, 99, -27, 0], 1, Tue Mar 02 01:45:20 CST 2021, Tue Mar 02 01:45:20 CST 2021]
2021-03-02 01:45:20.066  INFO 14740 --- [g-disruptor1-25] o.d.h.r.d.manager.AbstractHmilyDatabase  : sql is: update hmily_transaction_participant set status=? where participant_id = ? , params is: [1, 6832734414966759426]
2021-03-02 01:45:20.095  INFO 14740 --- [:20880-thread-7] o.d.h.d.d.a.service.AccountServiceImpl   : ============dubbo tcc 执行确认付款接口===============
2021-03-02 01:45:20.096  INFO 14740 --- [:20880-thread-7] o.d.h.core.disruptor.DisruptorProvider   : onData: HmilyRepositoryEvent(hmilyTransaction=null, hmilyParticipant=HmilyParticipant(participantId=6832734414966759426, participantRefId=null, transId=6832734414966759424, transType=TCC, status=1, appName=null, role=3, retry=0, targetClass=org.dromara.hmily.demo.dubbo.account.service.AccountServiceImpl, targetMethod=payment, confirmMethod=confirm, cancelMethod=cancel, version=1, createTime=Tue Mar 02 01:45:20 CST 2021, updateTime=Tue Mar 02 01:45:20 CST 2021, confirmHmilyInvocation=HmilyInvocation(targetClass=interface org.dromara.hmily.demo.common.account.api.AccountService, methodName=payment, parameterTypes=[class org.dromara.hmily.demo.common.account.dto.AccountDTO], args=[AccountDTO(userId=10000, amount=1)]), cancelHmilyInvocation=HmilyInvocation(targetClass=interface org.dromara.hmily.demo.common.account.api.AccountService, methodName=payment, parameterTypes=[class org.dromara.hmily.demo.common.account.dto.AccountDTO], args=[AccountDTO(userId=10000, amount=1)])), hmilyParticipantUndo=null, hmilyLocks=null, transId=6832734414966759424, type=22)
2021-03-02 01:45:20.097  INFO 14740 --- [g-disruptor1-25] o.d.h.r.d.manager.AbstractHmilyDatabase  : sql is: delete from hmily_transaction_participant where participant_id = ? , params is: [6832734414966759426]
```

```Inventory log
2021-03-02 01:45:20.066  INFO 6152 --- [:20881-thread-9] o.d.h.core.disruptor.DisruptorProvider   : onData: HmilyRepositoryEvent(hmilyTransaction=null, hmilyParticipant=HmilyParticipant(participantId=6832734415637848064, participantRefId=null, transId=6832734414966759424, transType=TCC, status=0, appName=null, role=3, retry=0, targetClass=org.dromara.hmily.demo.dubbo.inventory.service.InventoryServiceImpl, targetMethod=decrease, confirmMethod=confirmMethod, cancelMethod=cancelMethod, version=1, createTime=Tue Mar 02 01:45:20 CST 2021, updateTime=Tue Mar 02 01:45:20 CST 2021, confirmHmilyInvocation=HmilyInvocation(targetClass=interface org.dromara.hmily.demo.common.inventory.api.InventoryService, methodName=decrease, parameterTypes=[class org.dromara.hmily.demo.common.inventory.dto.InventoryDTO], args=[InventoryDTO(productId=1, count=1)]), cancelHmilyInvocation=HmilyInvocation(targetClass=interface org.dromara.hmily.demo.common.inventory.api.InventoryService, methodName=decrease, parameterTypes=[class org.dromara.hmily.demo.common.inventory.dto.InventoryDTO], args=[InventoryDTO(productId=1, count=1)])), hmilyParticipantUndo=null, hmilyLocks=null, transId=6832734414966759424, type=20)
2021-03-02 01:45:20.066  INFO 6152 --- [:20881-thread-9] o.d.h.d.d.i.s.InventoryServiceImpl       : Inventory called
2021-03-02 01:45:20.066  INFO 6152 --- [:20881-thread-9] o.d.h.core.disruptor.DisruptorProvider   : onData: HmilyRepositoryEvent(hmilyTransaction=null, hmilyParticipant=HmilyParticipant(participantId=6832734415637848064, participantRefId=null, transId=6832734414966759424, transType=TCC, status=1, appName=null, role=3, retry=0, targetClass=org.dromara.hmily.demo.dubbo.inventory.service.InventoryServiceImpl, targetMethod=decrease, confirmMethod=confirmMethod, cancelMethod=cancelMethod, version=1, createTime=Tue Mar 02 01:45:20 CST 2021, updateTime=Tue Mar 02 01:45:20 CST 2021, confirmHmilyInvocation=HmilyInvocation(targetClass=interface org.dromara.hmily.demo.common.inventory.api.InventoryService, methodName=decrease, parameterTypes=[class org.dromara.hmily.demo.common.inventory.dto.InventoryDTO], args=[InventoryDTO(productId=1, count=1)]), cancelHmilyInvocation=HmilyInvocation(targetClass=interface org.dromara.hmily.demo.common.inventory.api.InventoryService, methodName=decrease, parameterTypes=[class org.dromara.hmily.demo.common.inventory.dto.InventoryDTO], args=[InventoryDTO(productId=1, count=1)])), hmilyParticipantUndo=null, hmilyLocks=null, transId=6832734414966759424, type=21)
2021-03-02 01:45:20.074  INFO 6152 --- [g-disruptor1-25] o.d.h.r.d.manager.AbstractHmilyDatabase  : sql is: INSERT INTO hmily_transaction_participant (participant_id, participant_ref_id, trans_id, trans_type, status, app_name,role, retry, target_class, target_method, confirm_method, cancel_method, confirm_invocation, cancel_invocation, version, create_time, update_time) VALUES(?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ? ,? , ? , ?, ?), params is: [6832734415637848064, null, 6832734414966759424, TCC, 1, inventory-dubbo, 3, 0, org.dromara.hmily.demo.dubbo.inventory.service.InventoryServiceImpl, decrease, confirmMethod, cancelMethod, [1, 1, 0, 91, 76, 106, 97, 118, 97, 46, 108, 97, 110, 103, 46, 79, 98, 106, 101, 99, 116, -69, 1, 2, 1, 1, 111, 114, 103, 46, 100, 114, 111, 109, 97, 114, 97, 46, 104, 109, 105, 108, 121, 46, 100, 101, 109, 111, 46, 99, 111, 109, 109, 111, 110, 46, 105, 110, 118, 101, 110, 116, 111, 114, 121, 46, 100, 116, 111, 46, 73, 110, 118, 101, 110, 116, 111, 114, 121, 68, 84, -49, 1, 1, 2, 1, -126, 49, 1, 100, 101, 99, 114, 101, 97, 115, -27, 1, 2, 1, 1, 1, 0, 1, 1, 2, 111, 114, 103, 46, 100, 114, 111, 109, 97, 114, 97, 46, 104, 109, 105, 108, 121, 46, 100, 101, 109, 111, 46, 99, 111, 109, 109, 111, 110, 46, 105, 110, 118, 101, 110, 116, 111, 114, 121, 46, 97, 112, 105, 46, 73, 110, 118, 101, 110, 116, 111, 114, 121, 83, 101, 114, 118, 105, 99, -27, 0], [1, 1, 0, 91, 76, 106, 97, 118, 97, 46, 108, 97, 110, 103, 46, 79, 98, 106, 101, 99, 116, -69, 1, 2, 1, 1, 111, 114, 103, 46, 100, 114, 111, 109, 97, 114, 97, 46, 104, 109, 105, 108, 121, 46, 100, 101, 109, 111, 46, 99, 111, 109, 109, 111, 110, 46, 105, 110, 118, 101, 110, 116, 111, 114, 121, 46, 100, 116, 111, 46, 73, 110, 118, 101, 110, 116, 111, 114, 121, 68, 84, -49, 1, 1, 2, 1, -126, 49, 1, 100, 101, 99, 114, 101, 97, 115, -27, 1, 2, 1, 1, 1, 0, 1, 1, 2, 111, 114, 103, 46, 100, 114, 111, 109, 97, 114, 97, 46, 104, 109, 105, 108, 121, 46, 100, 101, 109, 111, 46, 99, 111, 109, 109, 111, 110, 46, 105, 110, 118, 101, 110, 116, 111, 114, 121, 46, 97, 112, 105, 46, 73, 110, 118, 101, 110, 116, 111, 114, 121, 83, 101, 114, 118, 105, 99, -27, 0], 1, Tue Mar 02 01:45:20 CST 2021, Tue Mar 02 01:45:20 CST 2021]
2021-03-02 01:45:20.088  INFO 6152 --- [g-disruptor1-25] o.d.h.r.d.manager.AbstractHmilyDatabase  : sql is: update hmily_transaction_participant set status=? where participant_id = ? , params is: [1, 6832734415637848064]
2021-03-02 01:45:20.099  INFO 6152 --- [20881-thread-10] o.d.h.d.d.i.s.InventoryServiceImpl       : ==========调用扣减库存confirm方法===========
2021-03-02 01:45:20.101  INFO 6152 --- [20881-thread-10] o.d.h.core.disruptor.DisruptorProvider   : onData: HmilyRepositoryEvent(hmilyTransaction=null, hmilyParticipant=HmilyParticipant(participantId=6832734415637848064, participantRefId=null, transId=6832734414966759424, transType=TCC, status=1, appName=null, role=3, retry=0, targetClass=org.dromara.hmily.demo.dubbo.inventory.service.InventoryServiceImpl, targetMethod=decrease, confirmMethod=confirmMethod, cancelMethod=cancelMethod, version=1, createTime=Tue Mar 02 01:45:20 CST 2021, updateTime=Tue Mar 02 01:45:20 CST 2021, confirmHmilyInvocation=HmilyInvocation(targetClass=interface org.dromara.hmily.demo.common.inventory.api.InventoryService, methodName=decrease, parameterTypes=[class org.dromara.hmily.demo.common.inventory.dto.InventoryDTO], args=[InventoryDTO(productId=1, count=1)]), cancelHmilyInvocation=HmilyInvocation(targetClass=interface org.dromara.hmily.demo.common.inventory.api.InventoryService, methodName=decrease, parameterTypes=[class org.dromara.hmily.demo.common.inventory.dto.InventoryDTO], args=[InventoryDTO(productId=1, count=1)])), hmilyParticipantUndo=null, hmilyLocks=null, transId=6832734414966759424, type=22)
2021-03-02 01:45:20.101  INFO 6152 --- [g-disruptor1-25] o.d.h.r.d.manager.AbstractHmilyDatabase  : sql is: delete from hmily_transaction_participant where participant_id = ? , params is: [6832734415637848064]

```

```order log
2021-03-02 01:45:20.057  INFO 18788 --- [0.0-8087-exec-4] o.d.h.core.disruptor.DisruptorProvider   : onData: HmilyRepositoryEvent(hmilyTransaction=HmilyTransaction(transId=6832734414966759424, appName=null, status=0, transType=TCC, retry=0, version=1, createTime=Tue Mar 02 01:45:20 CST 2021, updateTime=Tue Mar 02 01:45:20 CST 2021, hmilyParticipants=[]), hmilyParticipant=null, hmilyParticipantUndo=null, hmilyLocks=null, transId=6832734414966759424, type=10)
2021-03-02 01:45:20.057  INFO 18788 --- [0.0-8087-exec-4] o.d.h.core.disruptor.DisruptorProvider   : onData: HmilyRepositoryEvent(hmilyTransaction=null, hmilyParticipant=HmilyParticipant(participantId=6832734414966759425, participantRefId=null, transId=6832734414966759424, transType=TCC, status=0, appName=null, role=1, retry=0, targetClass=org.dromara.hmily.demo.dubbo.order.service.impl.PaymentServiceImpl, targetMethod=makePayment, confirmMethod=confirmOrderStatus, cancelMethod=cancelOrderStatus, version=1, createTime=Tue Mar 02 01:45:20 CST 2021, updateTime=Tue Mar 02 01:45:20 CST 2021, confirmHmilyInvocation=HmilyInvocation(targetClass=interface org.dromara.hmily.demo.dubbo.order.service.PaymentService, methodName=makePayment, parameterTypes=[class org.dromara.hmily.demo.common.order.entity.Order], args=[Order(id=null, createTime=Tue Mar 02 01:45:20 CST 2021, number=6832734414027235328, status=1, productId=1, totalAmount=1, count=1, userId=10000)]), cancelHmilyInvocation=HmilyInvocation(targetClass=interface org.dromara.hmily.demo.dubbo.order.service.PaymentService, methodName=makePayment, parameterTypes=[class org.dromara.hmily.demo.common.order.entity.Order], args=[Order(id=null, createTime=Tue Mar 02 01:45:20 CST 2021, number=6832734414027235328, status=1, productId=1, totalAmount=1, count=1, userId=10000)])), hmilyParticipantUndo=null, hmilyLocks=null, transId=6832734414966759424, type=20)
2021-03-02 01:45:20.057  INFO 18788 --- [0.0-8087-exec-4] o.d.h.d.d.o.s.impl.PaymentServiceImpl    : payment called
2021-03-02 01:45:20.058  INFO 18788 --- [g-disruptor1-33] o.d.h.r.d.manager.AbstractHmilyDatabase  : sql is: INSERT INTO hmily_transaction_global (trans_id, app_name, status, trans_type, retry, version, create_time, update_time) VALUES(?, ?, ?, ?, ?, ?, ?, ?), params is: [6832734414966759424, order-dubbo, 0, TCC, 0, 1, Tue Mar 02 01:45:20 CST 2021, Tue Mar 02 01:45:20 CST 2021]
2021-03-02 01:45:20.062  INFO 18788 --- [0.0-8087-exec-4] o.d.h.d.f.DubboHmilyTransactionFilter    : 拿到结果，role not PARTICIPANT
2021-03-02 01:45:20.063  INFO 18788 --- [g-disruptor1-33] o.d.h.r.d.manager.AbstractHmilyDatabase  : sql is: INSERT INTO hmily_transaction_participant (participant_id, participant_ref_id, trans_id, trans_type, status, app_name,role, retry, target_class, target_method, confirm_method, cancel_method, confirm_invocation, cancel_invocation, version, create_time, update_time) VALUES(?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ? ,? , ? , ?, ?), params is: [6832734414966759425, null, 6832734414966759424, TCC, 0, order-dubbo, 1, 0, org.dromara.hmily.demo.dubbo.order.service.impl.PaymentServiceImpl, makePayment, confirmOrderStatus, cancelOrderStatus, [1, 1, 0, 91, 76, 106, 97, 118, 97, 46, 108, 97, 110, 103, 46, 79, 98, 106, 101, 99, 116, -69, 1, 2, 1, 1, 111, 114, 103, 46, 100, 114, 111, 109, 97, 114, 97, 46, 104, 109, 105, 108, 121, 46, 100, 101, 109, 111, 46, 99, 111, 109, 109, 111, 110, 46, 111, 114, 100, 101, 114, 46, 101, 110, 116, 105, 116, 121, 46, 79, 114, 100, 101, -14, 1, 1, 2, 1, 2, 106, 97, 118, 97, 46, 117, 116, 105, 108, 46, 68, 97, 116, -27, 1, -78, -9, -109, -9, -2, 46, 0, 1, 54, 56, 51, 50, 55, 51, 52, 52, 49, 52, 48, 50, 55, 50, 51, 53, 51, 50, -72, 1, -126, 49, 1, 2, 12, 1, 2, 1, 0, 1, 49, 48, 48, 48, -80, 1, 109, 97, 107, 101, 80, 97, 121, 109, 101, 110, -12, 1, 2, 1, 1, 1, 0, 1, 1, 3, 111, 114, 103, 46, 100, 114, 111, 109, 97, 114, 97, 46, 104, 109, 105, 108, 121, 46, 100, 101, 109, 111, 46, 100, 117, 98, 98, 111, 46, 111, 114, 100, 101, 114, 46, 115, 101, 114, 118, 105, 99, 101, 46, 80, 97, 121, 109, 101, 110, 116, 83, 101, 114, 118, 105, 99, -27, 0], [1, 1, 0, 91, 76, 106, 97, 118, 97, 46, 108, 97, 110, 103, 46, 79, 98, 106, 101, 99, 116, -69, 1, 2, 1, 1, 111, 114, 103, 46, 100, 114, 111, 109, 97, 114, 97, 46, 104, 109, 105, 108, 121, 46, 100, 101, 109, 111, 46, 99, 111, 109, 109, 111, 110, 46, 111, 114, 100, 101, 114, 46, 101, 110, 116, 105, 116, 121, 46, 79, 114, 100, 101, -14, 1, 1, 2, 1, 2, 106, 97, 118, 97, 46, 117, 116, 105, 108, 46, 68, 97, 116, -27, 1, -78, -9, -109, -9, -2, 46, 0, 1, 54, 56, 51, 50, 55, 51, 52, 52, 49, 52, 48, 50, 55, 50, 51, 53, 51, 50, -72, 1, -126, 49, 1, 2, 12, 1, 2, 1, 0, 1, 49, 48, 48, 48, -80, 1, 109, 97, 107, 101, 80, 97, 121, 109, 101, 110, -12, 1, 2, 1, 1, 1, 0, 1, 1, 3, 111, 114, 103, 46, 100, 114, 111, 109, 97, 114, 97, 46, 104, 109, 105, 108, 121, 46, 100, 101, 109, 111, 46, 100, 117, 98, 98, 111, 46, 111, 114, 100, 101, 114, 46, 115, 101, 114, 118, 105, 99, 101, 46, 80, 97, 121, 109, 101, 110, 116, 83, 101, 114, 118, 105, 99, -27, 0], 1, Tue Mar 02 01:45:20 CST 2021, Tue Mar 02 01:45:20 CST 2021]
2021-03-02 01:45:20.067  INFO 18788 --- [0.0-8087-exec-4] o.d.h.d.f.DubboHmilyTransactionFilter    : 拿到结果，role not PARTICIPANT
2021-03-02 01:45:20.067  INFO 18788 --- [0.0-8087-exec-4] o.d.h.core.disruptor.DisruptorProvider   : onData: HmilyRepositoryEvent(hmilyTransaction=HmilyTransaction(transId=6832734414966759424, appName=null, status=1, transType=TCC, retry=0, version=1, createTime=Tue Mar 02 01:45:20 CST 2021, updateTime=Tue Mar 02 01:45:20 CST 2021, hmilyParticipants=[HmilyParticipant(participantId=6832734414966759425, participantRefId=null, transId=6832734414966759424, transType=TCC, status=0, appName=null, role=1, retry=0, targetClass=org.dromara.hmily.demo.dubbo.order.service.impl.PaymentServiceImpl, targetMethod=makePayment, confirmMethod=confirmOrderStatus, cancelMethod=cancelOrderStatus, version=1, createTime=Tue Mar 02 01:45:20 CST 2021, updateTime=Tue Mar 02 01:45:20 CST 2021, confirmHmilyInvocation=HmilyInvocation(targetClass=interface org.dromara.hmily.demo.dubbo.order.service.PaymentService, methodName=makePayment, parameterTypes=[class org.dromara.hmily.demo.common.order.entity.Order], args=[Order(id=null, createTime=Tue Mar 02 01:45:20 CST 2021, number=6832734414027235328, status=1, productId=1, totalAmount=1, count=1, userId=10000)]), cancelHmilyInvocation=HmilyInvocation(targetClass=interface org.dromara.hmily.demo.dubbo.order.service.PaymentService, methodName=makePayment, parameterTypes=[class org.dromara.hmily.demo.common.order.entity.Order], args=[Order(id=null, createTime=Tue Mar 02 01:45:20 CST 2021, number=6832734414027235328, status=1, productId=1, totalAmount=1, count=1, userId=10000)])), HmilyParticipant(participantId=6832734414966759426, participantRefId=null, transId=6832734414966759424, transType=TCC, status=null, appName=null, role=0, retry=0, targetClass=null, targetMethod=null, confirmMethod=null, cancelMethod=null, version=1, createTime=Tue Mar 02 01:45:20 CST 2021, updateTime=Tue Mar 02 01:45:20 CST 2021, confirmHmilyInvocation=HmilyInvocation(targetClass=interface org.dromara.hmily.demo.common.account.api.AccountService, methodName=payment, parameterTypes=[class org.dromara.hmily.demo.common.account.dto.AccountDTO], args=[AccountDTO(userId=10000, amount=1)]), cancelHmilyInvocation=HmilyInvocation(targetClass=interface org.dromara.hmily.demo.common.account.api.AccountService, methodName=payment, parameterTypes=[class org.dromara.hmily.demo.common.account.dto.AccountDTO], args=[AccountDTO(userId=10000, amount=1)])), HmilyParticipant(participantId=6832734415637848064, participantRefId=null, transId=6832734414966759424, transType=TCC, status=null, appName=null, role=0, retry=0, targetClass=null, targetMethod=null, confirmMethod=null, cancelMethod=null, version=1, createTime=Tue Mar 02 01:45:20 CST 2021, updateTime=Tue Mar 02 01:45:20 CST 2021, confirmHmilyInvocation=HmilyInvocation(targetClass=interface org.dromara.hmily.demo.common.inventory.api.InventoryService, methodName=decrease, parameterTypes=[class org.dromara.hmily.demo.common.inventory.dto.InventoryDTO], args=[InventoryDTO(productId=1, count=1)]), cancelHmilyInvocation=HmilyInvocation(targetClass=interface org.dromara.hmily.demo.common.inventory.api.InventoryService, methodName=decrease, parameterTypes=[class org.dromara.hmily.demo.common.inventory.dto.InventoryDTO], args=[InventoryDTO(productId=1, count=1)]))]), hmilyParticipant=null, hmilyParticipantUndo=null, hmilyLocks=null, transId=6832734414966759424, type=11)
2021-03-02 01:45:20.068  INFO 18788 --- [0.0-8087-exec-4] o.d.h.core.disruptor.DisruptorProvider   : onData: HmilyRepositoryEvent(hmilyTransaction=null, hmilyParticipant=HmilyParticipant(participantId=6832734414966759425, participantRefId=null, transId=6832734414966759424, transType=TCC, status=1, appName=null, role=1, retry=0, targetClass=org.dromara.hmily.demo.dubbo.order.service.impl.PaymentServiceImpl, targetMethod=makePayment, confirmMethod=confirmOrderStatus, cancelMethod=cancelOrderStatus, version=1, createTime=Tue Mar 02 01:45:20 CST 2021, updateTime=Tue Mar 02 01:45:20 CST 2021, confirmHmilyInvocation=HmilyInvocation(targetClass=interface org.dromara.hmily.demo.dubbo.order.service.PaymentService, methodName=makePayment, parameterTypes=[class org.dromara.hmily.demo.common.order.entity.Order], args=[Order(id=null, createTime=Tue Mar 02 01:45:20 CST 2021, number=6832734414027235328, status=1, productId=1, totalAmount=1, count=1, userId=10000)]), cancelHmilyInvocation=HmilyInvocation(targetClass=interface org.dromara.hmily.demo.dubbo.order.service.PaymentService, methodName=makePayment, parameterTypes=[class org.dromara.hmily.demo.common.order.entity.Order], args=[Order(id=null, createTime=Tue Mar 02 01:45:20 CST 2021, number=6832734414027235328, status=1, productId=1, totalAmount=1, count=1, userId=10000)])), hmilyParticipantUndo=null, hmilyLocks=null, transId=6832734414966759424, type=21)
2021-03-02 01:45:20.068  INFO 18788 --- [0.0-8087-exec-4] o.d.h.core.disruptor.DisruptorProvider   : onData: org.dromara.hmily.tcc.handler.StarterHmilyTccTransactionHandler$$Lambda$537/1926248292@5e8cf96f
切面耗时：12
消耗时间为:18
2021-03-02 01:45:20.069  INFO 18788 --- [ecutorHandler-7] o.d.h.core.disruptor.DisruptorProvider   : onData: HmilyRepositoryEvent(hmilyTransaction=HmilyTransaction(transId=6832734414966759424, appName=null, status=2, transType=TCC, retry=0, version=1, createTime=Tue Mar 02 01:45:20 CST 2021, updateTime=Tue Mar 02 01:45:20 CST 2021, hmilyParticipants=[HmilyParticipant(participantId=6832734414966759425, participantRefId=null, transId=6832734414966759424, transType=TCC, status=1, appName=null, role=1, retry=0, targetClass=org.dromara.hmily.demo.dubbo.order.service.impl.PaymentServiceImpl, targetMethod=makePayment, confirmMethod=confirmOrderStatus, cancelMethod=cancelOrderStatus, version=1, createTime=Tue Mar 02 01:45:20 CST 2021, updateTime=Tue Mar 02 01:45:20 CST 2021, confirmHmilyInvocation=HmilyInvocation(targetClass=interface org.dromara.hmily.demo.dubbo.order.service.PaymentService, methodName=makePayment, parameterTypes=[class org.dromara.hmily.demo.common.order.entity.Order], args=[Order(id=null, createTime=Tue Mar 02 01:45:20 CST 2021, number=6832734414027235328, status=1, productId=1, totalAmount=1, count=1, userId=10000)]), cancelHmilyInvocation=HmilyInvocation(targetClass=interface org.dromara.hmily.demo.dubbo.order.service.PaymentService, methodName=makePayment, parameterTypes=[class org.dromara.hmily.demo.common.order.entity.Order], args=[Order(id=null, createTime=Tue Mar 02 01:45:20 CST 2021, number=6832734414027235328, status=1, productId=1, totalAmount=1, count=1, userId=10000)])), HmilyParticipant(participantId=6832734414966759426, participantRefId=null, transId=6832734414966759424, transType=TCC, status=null, appName=null, role=0, retry=0, targetClass=null, targetMethod=null, confirmMethod=null, cancelMethod=null, version=1, createTime=Tue Mar 02 01:45:20 CST 2021, updateTime=Tue Mar 02 01:45:20 CST 2021, confirmHmilyInvocation=HmilyInvocation(targetClass=interface org.dromara.hmily.demo.common.account.api.AccountService, methodName=payment, parameterTypes=[class org.dromara.hmily.demo.common.account.dto.AccountDTO], args=[AccountDTO(userId=10000, amount=1)]), cancelHmilyInvocation=HmilyInvocation(targetClass=interface org.dromara.hmily.demo.common.account.api.AccountService, methodName=payment, parameterTypes=[class org.dromara.hmily.demo.common.account.dto.AccountDTO], args=[AccountDTO(userId=10000, amount=1)])), HmilyParticipant(participantId=6832734415637848064, participantRefId=null, transId=6832734414966759424, transType=TCC, status=null, appName=null, role=0, retry=0, targetClass=null, targetMethod=null, confirmMethod=null, cancelMethod=null, version=1, createTime=Tue Mar 02 01:45:20 CST 2021, updateTime=Tue Mar 02 01:45:20 CST 2021, confirmHmilyInvocation=HmilyInvocation(targetClass=interface org.dromara.hmily.demo.common.inventory.api.InventoryService, methodName=decrease, parameterTypes=[class org.dromara.hmily.demo.common.inventory.dto.InventoryDTO], args=[InventoryDTO(productId=1, count=1)]), cancelHmilyInvocation=HmilyInvocation(targetClass=interface org.dromara.hmily.demo.common.inventory.api.InventoryService, methodName=decrease, parameterTypes=[class org.dromara.hmily.demo.common.inventory.dto.InventoryDTO], args=[InventoryDTO(productId=1, count=1)]))]), hmilyParticipant=null, hmilyParticipantUndo=null, hmilyLocks=null, transId=6832734414966759424, type=11)
2021-03-02 01:45:20.069  INFO 18788 --- [ecutorHandler-7] o.d.h.d.d.o.s.impl.PaymentServiceImpl    : =========进行订单confirm操作完成================
2021-03-02 01:45:20.069  INFO 18788 --- [ecutorHandler-7] o.d.h.core.disruptor.DisruptorProvider   : onData: HmilyRepositoryEvent(hmilyTransaction=null, hmilyParticipant=HmilyParticipant(participantId=6832734414966759425, participantRefId=null, transId=6832734414966759424, transType=TCC, status=1, appName=null, role=1, retry=0, targetClass=org.dromara.hmily.demo.dubbo.order.service.impl.PaymentServiceImpl, targetMethod=makePayment, confirmMethod=confirmOrderStatus, cancelMethod=cancelOrderStatus, version=1, createTime=Tue Mar 02 01:45:20 CST 2021, updateTime=Tue Mar 02 01:45:20 CST 2021, confirmHmilyInvocation=HmilyInvocation(targetClass=interface org.dromara.hmily.demo.dubbo.order.service.PaymentService, methodName=makePayment, parameterTypes=[class org.dromara.hmily.demo.common.order.entity.Order], args=[Order(id=null, createTime=Tue Mar 02 01:45:20 CST 2021, number=6832734414027235328, status=1, productId=1, totalAmount=1, count=1, userId=10000)]), cancelHmilyInvocation=HmilyInvocation(targetClass=interface org.dromara.hmily.demo.dubbo.order.service.PaymentService, methodName=makePayment, parameterTypes=[class org.dromara.hmily.demo.common.order.entity.Order], args=[Order(id=null, createTime=Tue Mar 02 01:45:20 CST 2021, number=6832734414027235328, status=1, productId=1, totalAmount=1, count=1, userId=10000)])), hmilyParticipantUndo=null, hmilyLocks=null, transId=6832734414966759424, type=22)
2021-03-02 01:45:20.077  INFO 18788 --- [g-disruptor1-33] o.d.h.r.d.manager.AbstractHmilyDatabase  : sql is: update hmily_transaction_global  set status=?  where trans_id = ? , params is: [2, 6832734414966759424]
2021-03-02 01:45:20.089  INFO 18788 --- [g-disruptor1-33] o.d.h.r.d.manager.AbstractHmilyDatabase  : sql is: update hmily_transaction_participant set status=? where participant_id = ? , params is: [1, 6832734414966759425]
2021-03-02 01:45:20.093  INFO 18788 --- [g-disruptor1-33] o.d.h.r.d.manager.AbstractHmilyDatabase  : sql is: update hmily_transaction_global  set status=?  where trans_id = ? , params is: [2, 6832734414966759424]
2021-03-02 01:45:20.094  INFO 18788 --- [g-disruptor1-33] o.d.h.r.d.manager.AbstractHmilyDatabase  : sql is: delete from hmily_transaction_participant where participant_id = ? , params is: [6832734414966759425]
2021-03-02 01:45:20.097  INFO 18788 --- [ecutorHandler-7] o.d.h.d.f.DubboHmilyTransactionFilter    : 拿到结果，role not PARTICIPANT
2021-03-02 01:45:20.102  INFO 18788 --- [ecutorHandler-7] o.d.h.d.f.DubboHmilyTransactionFilter    : 拿到结果，role not PARTICIPANT
2021-03-02 01:45:20.102  INFO 18788 --- [ecutorHandler-7] o.d.h.core.disruptor.DisruptorProvider   : onData: HmilyRepositoryEvent(hmilyTransaction=HmilyTransaction(transId=6832734414966759424, appName=null, status=2, transType=TCC, retry=0, version=1, createTime=Tue Mar 02 01:45:20 CST 2021, updateTime=Tue Mar 02 01:45:20 CST 2021, hmilyParticipants=[HmilyParticipant(participantId=6832734414966759425, participantRefId=null, transId=6832734414966759424, transType=TCC, status=1, appName=null, role=1, retry=0, targetClass=org.dromara.hmily.demo.dubbo.order.service.impl.PaymentServiceImpl, targetMethod=makePayment, confirmMethod=confirmOrderStatus, cancelMethod=cancelOrderStatus, version=1, createTime=Tue Mar 02 01:45:20 CST 2021, updateTime=Tue Mar 02 01:45:20 CST 2021, confirmHmilyInvocation=HmilyInvocation(targetClass=interface org.dromara.hmily.demo.dubbo.order.service.PaymentService, methodName=makePayment, parameterTypes=[class org.dromara.hmily.demo.common.order.entity.Order], args=[Order(id=null, createTime=Tue Mar 02 01:45:20 CST 2021, number=6832734414027235328, status=1, productId=1, totalAmount=1, count=1, userId=10000)]), cancelHmilyInvocation=HmilyInvocation(targetClass=interface org.dromara.hmily.demo.dubbo.order.service.PaymentService, methodName=makePayment, parameterTypes=[class org.dromara.hmily.demo.common.order.entity.Order], args=[Order(id=null, createTime=Tue Mar 02 01:45:20 CST 2021, number=6832734414027235328, status=1, productId=1, totalAmount=1, count=1, userId=10000)])), HmilyParticipant(participantId=6832734414966759426, participantRefId=null, transId=6832734414966759424, transType=TCC, status=null, appName=null, role=0, retry=0, targetClass=null, targetMethod=null, confirmMethod=null, cancelMethod=null, version=1, createTime=Tue Mar 02 01:45:20 CST 2021, updateTime=Tue Mar 02 01:45:20 CST 2021, confirmHmilyInvocation=HmilyInvocation(targetClass=interface org.dromara.hmily.demo.common.account.api.AccountService, methodName=payment, parameterTypes=[class org.dromara.hmily.demo.common.account.dto.AccountDTO], args=[AccountDTO(userId=10000, amount=1)]), cancelHmilyInvocation=HmilyInvocation(targetClass=interface org.dromara.hmily.demo.common.account.api.AccountService, methodName=payment, parameterTypes=[class org.dromara.hmily.demo.common.account.dto.AccountDTO], args=[AccountDTO(userId=10000, amount=1)])), HmilyParticipant(participantId=6832734415637848064, participantRefId=null, transId=6832734414966759424, transType=TCC, status=null, appName=null, role=0, retry=0, targetClass=null, targetMethod=null, confirmMethod=null, cancelMethod=null, version=1, createTime=Tue Mar 02 01:45:20 CST 2021, updateTime=Tue Mar 02 01:45:20 CST 2021, confirmHmilyInvocation=HmilyInvocation(targetClass=interface org.dromara.hmily.demo.common.inventory.api.InventoryService, methodName=decrease, parameterTypes=[class org.dromara.hmily.demo.common.inventory.dto.InventoryDTO], args=[InventoryDTO(productId=1, count=1)]), cancelHmilyInvocation=HmilyInvocation(targetClass=interface org.dromara.hmily.demo.common.inventory.api.InventoryService, methodName=decrease, parameterTypes=[class org.dromara.hmily.demo.common.inventory.dto.InventoryDTO], args=[InventoryDTO(productId=1, count=1)]))]), hmilyParticipant=null, hmilyParticipantUndo=null, hmilyLocks=null, transId=6832734414966759424, type=12)
2021-03-02 01:45:20.103  INFO 18788 --- [g-disruptor1-33] o.d.h.r.d.manager.AbstractHmilyDatabase  : sql is: delete from hmily_transaction_global where trans_id = ? , params is: [6832734414966759424]

```

